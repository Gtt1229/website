<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>YUV-WebSocket-Stream Example | Oat++</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/logo_x64.png"><link rel='canonical' href='https://oatpp.io/examples/yuv-websocket-stream/'/>
    <meta name="description" content="Example project how-to create a YUV image stream from a V4L device (i.E. Webcam) using websockets.">
    <link rel="preload" href="/assets/css/0.styles.5f58b113.css" as="style"><link rel="preload" href="/assets/js/app.4c0e249b.js" as="script"><link rel="preload" href="/assets/js/3.0e791e97.js" as="script"><link rel="preload" href="/assets/js/326.c8bb8cc8.js" as="script"><link rel="preload" href="/assets/js/7.a7c042c4.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.5f58b113.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/logo_x400.png" alt="Oat++" class="logo"> <span class="site-name can-hide">Oat++</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/start/" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/support/" class="nav-link">
  Support
</a></div> <a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/start/" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/support/" class="nav-link">
  Support
</a></div> <a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>About</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Benchmark</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Examples</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/examples/api-client/" class="sidebar-link">HTTP Requests With ApiClient</a></li><li><a href="/examples/async-api/" class="sidebar-link">Asynchronous API</a></li><li><a href="/examples/crud/" class="sidebar-link">CRUD API With Swagger-UI</a></li><li><a href="/examples/consul/" class="sidebar-link">Consul Integration</a></li><li><a href="/examples/hls-media-stream/" class="sidebar-link">HTTP Live Streaming Server</a></li><li><a href="/examples/iot-hue-ssdp/" class="sidebar-link">IoT Hue Emulator</a></li><li><a href="/examples/libressl/" class="sidebar-link">TLS With Libressl</a></li><li><a href="/examples/microservices/" class="sidebar-link">Microservices</a></li><li><a href="/examples/mongodb/" class="sidebar-link">MongoDB</a></li><li><a href="/examples/postgresql/" class="sidebar-link">PostgreSQL Database</a></li><li><a href="/examples/websocket/" class="sidebar-link">WebSocket Examples</a></li><li><a href="/examples/yuv-websocket-stream/" aria-current="page" class="active sidebar-link">YUV WebSocket Stream</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Installation</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Modules</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>API Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="example-yuv-websocket-stream"><a href="#example-yuv-websocket-stream" class="header-anchor">#</a> Example-YUV-Websocket-Stream <div data-v-4414e9e8></div></h1> <p><a href="https://github.com/oatpp/example-yuv-websocket-stream" target="_blank" rel="noopener noreferrer">Github Repository<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Example project how-to create a YUV image stream from a V4L device (i.E. Webcam) using websockets.
The raw YUV image stream is send via a websocket connection. In the example Webpage, this YUV stream is converted to an HTML5 Canvas using JavaScript.
If you experience lag in the video its either your PC not being fast enough for the JavaScript conversion or the V4L2 stack.
The example webpage also runs fine on newer Smartphones!</p> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>This project is using <a href="https://github.com/oatpp/oatpp" target="_blank" rel="noopener noreferrer">oatpp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/oatpp/oatpp-websocket" target="_blank" rel="noopener noreferrer">oatpp-websocket<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://github.com/oatpp/oatpp-swagger" target="_blank" rel="noopener noreferrer">oatpp-swagger<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> modules.</p> <h3 id="project-layout"><a href="#project-layout" class="header-anchor">#</a> Project layout</h3> <div class="language- extra-class"><pre class="language-text"><code>|- CMakeLists.txt                        // projects CMakeLists.txt
|- src/
|   |
|   |- controller/                       // Folder containing CamAPIController where all endpoints are declared
|   |- backend/                          // Folder with &quot;business logic&quot;
|   |- dto/                              // DTOs are declared here
|   |- SwaggerComponent.hpp              // Swagger-UI config
|   |- AppComponent.hpp                  // Service config
|   |- App.cpp                           // main() is here
|
|- utility/install-oatpp-modules.sh      // utility script to install required oatpp-modules.
</code></pre></div><hr> <h3 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h3> <p>When running this example, a Oat++ REST-API is launched and a demo webpage is accessible under <code>&lt;yourip/localhost&gt;:8000/v0/cam/stream</code>.
The raw data is send out on the websocket (<code>&lt;yourip/localhost&gt;:8000/v0/cam/stream/ws</code>) as soon as one client is connected and stops if all clients have disconnected.
Each websocket frame contains a whole image as received from V4L2.</p> <h3 id="quirks"><a href="#quirks" class="header-anchor">#</a> Quirks</h3> <h4 id="hardcoded-dimensions"><a href="#hardcoded-dimensions" class="header-anchor">#</a> Hardcoded Dimensions</h4> <p>The dimensions are Hardcoded to <em>640x480</em> interlaced YUYV. Thus each image <em>complete</em> image is 614400 bytes.
You can change the dimensions in <code>src/backend/V4LGrabber.cpp:589</code> and have to update them in <code>res/cam/wsImageView.html:31-32</code></p> <p><strong>src/backend/V4LGrabber.cpp:589</strong></p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>width       <span class="token operator">=</span> <span class="token number">640</span><span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>height      <span class="token operator">=</span> <span class="token number">480</span><span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>pixelformat <span class="token operator">=</span> V4L2_PIX_FMT_YUYV<span class="token punctuation">;</span>
fmt<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span>pix<span class="token punctuation">.</span>field       <span class="token operator">=</span> V4L2_FIELD_INTERLACED<span class="token punctuation">;</span>
</code></pre></div><p><strong>res/cam/wsImageView.html:31-32</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> imgData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createImageData</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> grayScale <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token operator">*</span><span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="partial-images"><a href="#partial-images" class="header-anchor">#</a> Partial Images</h4> <p>Some webcams or V4L2 implementations are buggy and (sometimes) transfer partial images (only).
When you know your image size, you must come up with your own stiching mechanism.</p> <h4 id="video-lags"><a href="#video-lags" class="header-anchor">#</a> Video Lags</h4> <p>Depending on the used IO method (<code>read</code>, <code>mmap</code> or <code>userptr</code>) between V4L2&lt;-&gt;Oat++ some lag can occur or the stream does not work at all.
The example is programmed to use <code>mmap</code> in <code>src/controller/CamAPIController.cpp:31</code>.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>m_grabber <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>V4LGrabber<span class="token operator">&gt;</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CamAPIController<span class="token operator">::</span>handle_frame<span class="token punctuation">,</span> m_imageReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> V4LGrabber<span class="token operator">::</span>IO_METHOD_MMAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The methods can roughly be described by:</p> <ul><li><strong>read:</strong> Simple <code>read</code> calls on <code>/dev/videoX</code> (most simple, widely supported)</li> <li><strong>mmap:</strong> Memory mapping the data to the user-memory (should be a lot faster, memory efficient)</li> <li><strong>userptr:</strong> User created memory region is given to kernel and the kernel uses this region as buffer (potentially dangerous, memory efficient)</li></ul> <h3 id="build-and-run"><a href="#build-and-run" class="header-anchor">#</a> Build and Run</h3> <h4 id="using-cmake"><a href="#using-cmake" class="header-anchor">#</a> Using CMake</h4> <p><strong>Requires</strong></p> <ul><li><code>oatpp</code>, <code>oatpp-websocket</code> and <code>oatpp-swagger</code> modules installed. You may run <code>utility/install-oatpp-modules.sh</code>
script to install required oatpp modules.</li> <li>Linux with <code>V4L2</code> development libraries installed</li></ul> <div class="language- extra-class"><pre class="language-text"><code>$ mkdir build &amp;&amp; cd build
$ cmake ..
$ make 
$ ./example-yuv-websocket-stream-exe        # - run application.
</code></pre></div><h4 id="in-docker"><a href="#in-docker" class="header-anchor">#</a> In Docker</h4> <div class="language- extra-class"><pre class="language-text"><code>$ docker build -t example-yuv-websocket-stream .
$ docker run -p 8000:8000 -t example-yuv-websocket-stream-exe
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/oatpp/website/edit/master/docs/examples/yuv-websocket-stream/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/examples/websocket/" class="prev">
        WebSocket Examples
      </a></span> <span class="next"><a href="/docs/installation/unix-linux/">
        Unix/Linux
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4c0e249b.js" defer></script><script src="/assets/js/3.0e791e97.js" defer></script><script src="/assets/js/326.c8bb8cc8.js" defer></script><script src="/assets/js/7.a7c042c4.js" defer></script>
  </body>
</html>
