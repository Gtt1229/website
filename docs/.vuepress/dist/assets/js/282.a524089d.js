(window.webpackJsonp=window.webpackJsonp||[]).push([[282],{654:function(e,t,s){"use strict";s.r(t);var a=s(42),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"_2-million-websockets"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-million-websockets"}},[e._v("#")]),e._v(" 2 Million WebSockets "),s("seo")],1),e._v(" "),s("p",[e._v("Date - "),s("code",[e._v("May 5, 2019")]),s("br"),e._v("\nOatpp version - "),s("code",[e._v("0.19.4")])]),e._v(" "),s("p",[e._v("This article describes oatpp benchmark for 2 Million "),s("strong",[e._v("fully-loaded")]),e._v(" concurrent websocket connections.")]),e._v(" "),s("h2",{attrs:{id:"setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#setup"}},[e._v("#")]),e._v(" Setup")]),e._v(" "),s("img",{attrs:{alt:"Setup diagram",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/diagram/2m-websockets-setup.svg?sanitize=true"}}),e._v(" "),s("ul",[s("li",[e._v("Server Machine - Google-Cloud "),s("strong",[e._v("n1-highmem-8 (8 vCPUs, 52 GB memory)")]),e._v(" running Debian GNU/Linux 9.")]),e._v(" "),s("li",[e._v("Client Machine - Google-Cloud "),s("strong",[e._v("n1-highmem-8 (8 vCPUs, 52 GB memory)")]),e._v(" running Debian GNU/Linux 9.")])]),e._v(" "),s("p",[s("strong",[e._v("Server application")]),e._v(" listens to 100 ports from 8000 to 8099\n(in order to prevent ephemeral ports exhaustion on the client - as we running all 2m clients on the same machine).\nOnce there is a message on WebSocket, server will echo client's message adding "),s("code",[e._v('"Hello from oatpp!"')]),e._v(" at the beginning.")]),e._v(" "),s("p",[s("strong",[e._v("Client application")]),e._v(" opens 20k connections on each port, waits all connections are ready (all WebSocket handshakes are done) then starts the load.\nEach of 2-million websocket clients continuously sends messages to server. Once message is sent client sends another one.")]),e._v(" "),s("p",[e._v("Both server and client applications are running asynchronous oatpp server/client based on "),s("RouterLink",{attrs:{to:"/docs/oatpp-coroutines/"}},[e._v("oatpp coroutines")]),e._v(".")],1),e._v(" "),s("h2",{attrs:{id:"results"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#results"}},[e._v("#")]),e._v(" Results")]),e._v(" "),s("p",[e._v("Server showed stable performance through all the benchmark test delivering about "),s("code",[e._v("9 Million")]),e._v(" messages per minute ("),s("code",[e._v("~32.7 Mb/Second")]),e._v("):")]),e._v(" "),s("img",{attrs:{alt:"Server monitoring graph",src:"https://github.com/lganzzzo/oatpp-website-res/raw/master/benchmark/websocket/2m/monitoring.png",width:"800px"}}),e._v(" "),s("h3",{attrs:{id:"server-stats"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server-stats"}},[e._v("#")]),e._v(" Server Stats")]),e._v(" "),s("h4",{attrs:{id:"resource-consumption"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resource-consumption"}},[e._v("#")]),e._v(" Resource consumption")]),e._v(" "),s("p",[e._v("Server memory consumption was stable at about 15GB.")]),e._v(" "),s("img",{attrs:{alt:"Server resource consumption",border:"1",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-server.png",width:"800px"}}),e._v(" "),s("h4",{attrs:{id:"throughput"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#throughput"}},[e._v("#")]),e._v(" Throughput")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SOCKETS:          2000000          # - Number of connected clients                                                       \nFRAMES_TOTAL:     2055762317       # - Frames received by server (total)                                                          \nMESSAGES_TOTAL:   2055711187       # - Messages received by server (total)                                                          \nFRAMES_PER_MIN:   9198391.630007   # - Frames received rate per minute                                               \nMESSAGES_PER_MIN: 9194998.122585   # - Messages received rate per minute  \n")])])]),s("h3",{attrs:{id:"client-stats"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-stats"}},[e._v("#")]),e._v(" Client Stats")]),e._v(" "),s("h4",{attrs:{id:"resource-consumption-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resource-consumption-2"}},[e._v("#")]),e._v(" Resource consumption")]),e._v(" "),s("p",[e._v("Client memory consumption was stable at about 10GB.")]),e._v(" "),s("img",{attrs:{alt:"Server resource consumption",border:"1",src:"https://raw.githubusercontent.com/lganzzzo/oatpp-website-res/master/benchmark/websocket/2m/top-client.png",width:"800px"}}),e._v(" "),s("h4",{attrs:{id:"throughput-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#throughput-2"}},[e._v("#")]),e._v(" Throughput")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SOCKETS:          2000000          # - Number of connected clients                                                       \nFRAMES_TOTAL:     1986591173       # - Frames received by client (total)                                                          \nMESSAGES_TOTAL:   1986358027       # - Messages received by client (total)                                                          \nFRAMES_PER_MIN:   8971818.390638   # - Frames received rate per minute                                               \nMESSAGES_PER_MIN: 8973755.731700   # - Messages received rate per minute  \n")])])]),s("h2",{attrs:{id:"steps-to-reproduce"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#steps-to-reproduce"}},[e._v("#")]),e._v(" Steps to Reproduce")]),e._v(" "),s("p",[e._v("Create two "),s("code",[e._v("n1-highmem-8 (8 vCPUs, 52 GB memory) - Debian GNU/Linux 9")]),e._v(" instances in same VPC on Google Cloud.")]),e._v(" "),s("h3",{attrs:{id:"execute-the-following-commands-for-both-instances-ssh"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#execute-the-following-commands-for-both-instances-ssh"}},[e._v("#")]),e._v(" Execute the following commands for both instances (SSH).")]),e._v(" "),s("ul",[s("li",[e._v("Install git")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("su")]),e._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" update\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" -y "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\n")])])]),s("ul",[s("li",[e._v("Clone "),s("a",{attrs:{href:"https://github.com/oatpp/benchmark-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("benchmark-websocket repo"),s("OutboundLink")],1),e._v(" and "),s("code",[e._v("cd")]),e._v(" to repo folder")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" clone https://github.com/oatpp/benchmark-websocket\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\n$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" benchmark-websocket\n")])])]),s("ul",[s("li",[e._v("Install "),s("code",[e._v("oatpp")]),e._v(" and "),s("code",[e._v("oatpp-websocket")]),e._v(" modules (run ./prepare.sh script).")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ ./prepare.sh\n")])])]),s("ul",[s("li",[e._v("Configure environment (run ./sock-config.sh script)")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ ./sock-config.sh\n$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("ulimit")]),e._v(" -n "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3000000")]),e._v("\n")])])]),s("h3",{attrs:{id:"build-and-run-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#build-and-run-server"}},[e._v("#")]),e._v(" Build and Run Server")]),e._v(" "),s("p",[e._v("Commands for server instance only:")]),e._v(" "),s("ul",[s("li",[e._v("Build server")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" server/build/\n$ cmake "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v("\n")])])]),s("ul",[s("li",[e._v("Run server")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ ./wsb-server-exe --tp "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),e._v(" --tio "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("\n")])])]),s("p",[e._v("where:"),s("br"),e._v(" "),s("code",[e._v("--tp")]),e._v(" - number of data-processing threads."),s("br"),e._v(" "),s("code",[e._v("--tio")]),e._v(" - number of I/O workers.")]),e._v(" "),s("h3",{attrs:{id:"build-and-run-client"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#build-and-run-client"}},[e._v("#")]),e._v(" Build and Run Client")]),e._v(" "),s("p",[e._v("Commands for client instance only:")]),e._v(" "),s("ul",[s("li",[e._v("Build client")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" client/build/\n$ cmake "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v("\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v("\n")])])]),s("ul",[s("li",[e._v("Run client")])]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("$ ./wsb-client-exe --tp "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("9")]),e._v(" --tio "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v(" -h "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("server-private-ip"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --socks-max "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2000000")]),e._v(" --socks-port "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("20000")]),e._v(" --si "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1000")]),e._v(" --sf "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("50")]),e._v("\n")])])]),s("p",[e._v("where:"),s("br"),e._v(" "),s("code",[e._v("--tp")]),e._v(" - number of data-processing threads."),s("br"),e._v(" "),s("code",[e._v("--tio")]),e._v(" - number of I/O workers."),s("br"),e._v(" "),s("code",[e._v("-h <server-private-ip>")]),e._v(" - substitute "),s("strong",[e._v("private-ip")]),e._v(" of server instance here."),s("br"),e._v(" "),s("code",[e._v("--socks-max")]),e._v(" - how many client connections to establish."),s("br"),e._v(" "),s("code",[e._v("--socks-port")]),e._v(" - how many client connections per port."),s("br"),e._v(" "),s("code",[e._v("--si 1000 --sf 50")]),e._v(" - control how fast clients will connect to server. Here - each "),s("code",[e._v("1000")]),e._v(" iterations sleep for "),s("code",[e._v("50")]),e._v(" milliseconds.")]),e._v(" "),s("p",[s("strong",[e._v("Note")]),e._v(" - clients will not start load until all clients are connected."),s("br"),e._v(" "),s("strong",[e._v("Note")]),e._v(" - client app will fail with assertion if any of clients has failed.")]),e._v(" "),s("h2",{attrs:{id:"links"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#links"}},[e._v("#")]),e._v(" Links")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://github.com/oatpp/benchmark-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("This benchmark repo"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docs/oatpp-coroutines/"}},[e._v("About oatpp coroutines")])],1),e._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/oatpp/oatpp-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("oatpp-websocket repo"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/oatpp/oatpp",target:"_blank",rel:"noopener noreferrer"}},[e._v("oatpp repo"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);